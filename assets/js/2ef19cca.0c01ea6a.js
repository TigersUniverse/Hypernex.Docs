"use strict";(self.webpackChunkhypernex_docs=self.webpackChunkhypernex_docs||[]).push([[1181],{3905:(e,t,a)=>{a.d(t,{Zo:()=>u,kt:()=>m});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),d=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},u=function(e){var t=d(e.components);return n.createElement(s.Provider,{value:t},e.children)},p="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),p=d(a),h=r,m=p["".concat(s,".").concat(h)]||p[h]||c[h]||i;return a?n.createElement(m,o(o({ref:t},u),{},{components:a})):n.createElement(m,o({ref:t},u))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,o=new Array(i);o[0]=h;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[p]="string"==typeof e?e:r,o[1]=l;for(var d=2;d<i;d++)o[d]=a[d];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}h.displayName="MDXCreateElement"},2826:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>c,frontMatter:()=>i,metadata:()=>l,toc:()=>d});var n=a(87462),r=(a(67294),a(3905));const i={sidebar_position:0},o="Setup CDN",l={unversionedId:"hosting-docs/setup/setupcdn",id:"hosting-docs/setup/setupcdn",title:"Setup CDN",description:"A CDN is required to handle both file downloads and uploads from clients for all User-Generated Content. They are designed to be lightweight and their goal is to reduce stress off of the main server.",source:"@site/docs/hosting-docs/setup/setupcdn.md",sourceDirName:"hosting-docs/setup",slug:"/hosting-docs/setup/setupcdn",permalink:"/docs/hosting-docs/setup/setupcdn",draft:!1,editUrl:"https://github.com/TigersUniverse/Hypernex.Docs/docs/hosting-docs/setup/setupcdn.md",tags:[],version:"current",sidebarPosition:0,frontMatter:{sidebar_position:0},sidebar:"hostingSidebar",previous:{title:"API Server Setup",permalink:"/docs/hosting-docs/setup/setupapi"},next:{title:"Web Setup",permalink:"/docs/hosting-docs/setup/setupweb"}},s={},d=[{value:"Setting Up the Server",id:"setting-up-the-server",level:2},{value:"Configuring the Server",id:"configuring-the-server",level:2},{value:"Running the Server",id:"running-the-server",level:2},{value:"Proxying the CDN",id:"proxying-the-cdn",level:2},{value:"Setting up Caddy",id:"setting-up-caddy",level:3},{value:"Setting up Without a Proxy",id:"setting-up-without-a-proxy",level:3},{value:"Adding the CDN to the API",id:"adding-the-cdn-to-the-api",level:2}],u={toc:d},p="wrapper";function c(e){let{components:t,...a}=e;return(0,r.kt)(p,(0,n.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"setup-cdn"},"Setup CDN"),(0,r.kt)("p",null,"A CDN is required to handle both file downloads and uploads from clients for all User-Generated Content. They are designed to be lightweight and their goal is to reduce stress off of the main server."),(0,r.kt)("h2",{id:"setting-up-the-server"},"Setting Up the Server"),(0,r.kt)("p",null,"To setup a server, navigate to the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/TigersUniverse/HypernexCDN/releases/latest"},"latest release")," and download the library which targets your server's platform."),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"If you're on linux, you may need to make the binary executable. Run the following command to do so."),(0,r.kt)("pre",{parentName:"admonition"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"chmod +x hypernexcdn_linux-[architecture]\n"))),(0,r.kt)("h2",{id:"configuring-the-server"},"Configuring the Server"),(0,r.kt)("p",null,"After you run the executable once, you should see a ",(0,r.kt)("inlineCode",{parentName:"p"},"config.toml")," file appear in the same directory as the executable. Open this file with your preferred editor."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-toml"},"API_Server = 'http://hypernex.local/api/v1/'\nAWS_key = 'access-key'\nAWS_secret = 'access-secret'\nAWS_endpoint = 'http://s3.local:9000'\nAWS_region = 'us-1'\nAWS_bucket = 'hypernex'\nMongo_URI = 'mongodb://mongodb-server'\nREDIS_Address = 'redis://redis.local:6379/0'\nPICS_Bucket = '/'\nPUBLIC_PICS = 'root-pics-dir/'\n")),(0,r.kt)("p",null,"Here's a quick rundown of every value and what it means"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"API_Server"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"The base URL for the API server"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"AWS_key"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"The key to your S3 bucket"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"AWS_secret"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"The secret to your S3 bucket"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"AWS_endpoint"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"The endpoint your S3 bucket is located"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"AWS_region"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"The region your S3 bucket is located"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"AWS_bucket"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"The name of your S3 bucket"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"Mongo_URI"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"The URI to connect to your Mongo database"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"REDIS_Address"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"The Redis URI to connect to your Redis database"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"PICS_Bucket"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"The name of the bucket where your public pictures are stored"),(0,r.kt)("li",{parentName:"ul"},"Enables the ",(0,r.kt)("inlineCode",{parentName:"li"},"/randomImage")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"/picture/{picture}")," endpoints when valid"),(0,r.kt)("li",{parentName:"ul"},"If your pictures are in the same bucket, set this to ",(0,r.kt)("inlineCode",{parentName:"li"},"/")),(0,r.kt)("li",{parentName:"ul"},"If you do not wish to use this feature, leave it blank"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"PUBLIC_PICS")," ",(0,r.kt)("em",{parentName:"li"},"(Optional)"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"The Prefix to all of your public images"),(0,r.kt)("li",{parentName:"ul"},"If your pictures are in the same bucket, be sure to add a trailing slash after you put the directory name")))),(0,r.kt)("p",null,"Fill in these values as needed and then start the server."),(0,r.kt)("h2",{id:"running-the-server"},"Running the Server"),(0,r.kt)("p",null,"To run the server, you can run the following command (on linux)"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"./hypernexcdn_linux-[architecture]\n")),(0,r.kt)("p",null,"or if you're on Windows, simply run the executable."),(0,r.kt)("p",null,"If you'd like your process to run in the background on Linux, look into using tmux or a systemd process."),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"The HypernexCDN is designed to gracefully handle errors. If something doesn't work properly, whether that be from a service outage or malformed user input, the server should handle it. If the server panics and crashes, there is likely a greater issue going on that needs to be ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/TigersUniverse/HypernexCDN/issues"},"reported"),".")),(0,r.kt)("h2",{id:"proxying-the-cdn"},"Proxying the CDN"),(0,r.kt)("p",null,"The HypernexCDN is designed to run behind a proxy with caching enabled. This allows easy SSL configuration and object caching locally to reduce transfer costs. While you can use any reverse proxy, we recommend using ",(0,r.kt)("a",{parentName:"p",href:"https://caddyserver.com/"},"Caddy")," for its reliability and ease-of-use."),(0,r.kt)("h3",{id:"setting-up-caddy"},"Setting up Caddy"),(0,r.kt)("p",null,"To setup Caddy with object caching, we need to build it with the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/caddyserver/cache-handler"},"cache-handler")," module. We will use ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/caddyserver/xcaddy"},"xcaddy")," to build caddy automatically and easily."),(0,r.kt)("p",null,"To install xcaddy on linux, simply run the following commands"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"sudo apt install -y debian-keyring debian-archive-keyring apt-transport-https\ncurl -1sLf 'https://dl.cloudsmith.io/public/caddy/xcaddy/gpg.key' | sudo gpg --dearmor -o /usr/share/keyrings/caddy-xcaddy-archive-keyring.gpg\ncurl -1sLf 'https://dl.cloudsmith.io/public/caddy/xcaddy/debian.deb.txt' | sudo tee /etc/apt/sources.list.d/caddy-xcaddy.list\nsudo apt update\nsudo apt install xcaddy\n")),(0,r.kt)("p",null,"If you are on a non-linux platform, check the xcaddy ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/caddyserver/xcaddy/releases/latest"},"latest release")," for a pre-built binary that works for you, or build xcaddy from source yourself."),(0,r.kt)("p",null,"Once you have xcaddy installed, we can now build caddy with our two modules"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The cache-handler module"),(0,r.kt)("li",{parentName:"ul"},"Your selected storage model")),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"cache-handler requires a storage module to be installed with it, otherwise it will fail. Below is a list of storages you can use:"),(0,r.kt)("ul",{parentName:"admonition"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/dgraph-io/badger"},"Badger")," ",(0,r.kt)("inlineCode",{parentName:"li"},"github.com/darkweak/storages/badger/caddy")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/etcd-io/etcd"},"Etcd")," ",(0,r.kt)("inlineCode",{parentName:"li"},"github.com/darkweak/storages/etcd/caddy")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/redis/go-redis"},"Go-redis")," ",(0,r.kt)("inlineCode",{parentName:"li"},"github.com/darkweak/storages/go-redis/caddy")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/nats-io/nats-server"},"Nats")," ",(0,r.kt)("inlineCode",{parentName:"li"},"github.com/darkweak/storages/nats/caddy")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/nutsdb/nutsdb"},"Nuts")," ",(0,r.kt)("inlineCode",{parentName:"li"},"github.com/darkweak/storages/nuts/caddy")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/buraksezer/olric"},"Olric")," ",(0,r.kt)("inlineCode",{parentName:"li"},"github.com/darkweak/storages/olric/caddy")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/maypok86/otter"},"Otter")," ",(0,r.kt)("inlineCode",{parentName:"li"},"github.com/darkweak/storages/otter/caddy")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/redis/rueidis"},"Redis")," ",(0,r.kt)("inlineCode",{parentName:"li"},"github.com/darkweak/storages/redis/caddy")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/darkweak/simplefs"},"Simplefs")," ",(0,r.kt)("inlineCode",{parentName:"li"},"github.com/darkweak/storages/simplefs/caddy"))),(0,r.kt)("p",{parentName:"admonition"},"We recommend using ",(0,r.kt)("inlineCode",{parentName:"p"},"simplefs")," and will be explaining how to use it, but you can select whatever the best storage is to run on your server. Keep in mind that whichever storage solution you pick, you will be responsible for setting up correctly and securely."),(0,r.kt)("p",{parentName:"admonition"},"You can read more about storages ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/darkweak/storages/"},"here"),".")),(0,r.kt)("p",null,"For this tutorial, we will be building caddy with cache-handler and simplefs. Run the command below to start building caddy with the two modules."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"xcaddy build --with github.com/darkweak/souin/plugins/caddy --with github.com/darkweak/storages/simplefs/caddy\n")),(0,r.kt)("p",null,"And after a few minutes, we should see our caddy executable built at ",(0,r.kt)("inlineCode",{parentName:"p"},"./caddy"),"."),(0,r.kt)("p",null,"Now we need to create our configuration file. In the same directory as caddy, create a new file called ",(0,r.kt)("inlineCode",{parentName:"p"},"Caddyfile")," and input the following text"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-caddy"},"{\n  cache {\n    simplefs {\n      configuration {\n          size 10000\n          path cache\n      }\n    }\n  }\n  regex {\n    exclude /randomImage\n    exclude /randomImage/*\n  }\n  ttl 1800s\n}\nexamplecdn.yoururl.com {\n  cache\n  reverse_proxy :3333 {\n      flush_interval -1\n  }\n}\n")),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"Increase or decrease the ttl value to keep or dispose of cache on the server faster or slower!")),(0,r.kt)("p",null,"Then you'll replace ",(0,r.kt)("inlineCode",{parentName:"p"},"examplecdn.yoururl.com")," with the domain that will be interacting with the CDN."),(0,r.kt)("admonition",{type:"warning"},(0,r.kt)("p",{parentName:"admonition"},"The domain should be different from your API's domain. While you may be able to setup Caddy to reverse proxy requests to both your API and CDN on the same server, this configuration is not supported.")),(0,r.kt)("p",null,"After you create your Caddyfile, you are now ready to start your Caddy server!"),(0,r.kt)("p",null,"To run caddy in the foreground, run"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"./caddy run\n")),(0,r.kt)("p",null,"or to run caddy in the background, run"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"./caddy start\n")),(0,r.kt)("p",null,"and now your proxy is ready! You should be able to access the CDN publicly."),(0,r.kt)("h3",{id:"setting-up-without-a-proxy"},"Setting up Without a Proxy"),(0,r.kt)("admonition",{type:"warning"},(0,r.kt)("p",{parentName:"admonition"},"Setting up without a proxy is ",(0,r.kt)("strong",{parentName:"p"},"NOT")," recommended for production as there will be ",(0,r.kt)("strong",{parentName:"p"},"NO CACHING")," (which will increase S3 costs) and ",(0,r.kt)("strong",{parentName:"p"},"NO SSL"),", which means ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"all files will be transferred insecurely")),". You should only ever do this if you are setting up a development server and your API server is not accessible to the public.")),(0,r.kt)("p",null,"If you wish to not use a proxy, simply access the CDN at ",(0,r.kt)("inlineCode",{parentName:"p"},"http://localhost:3333/"),"."),(0,r.kt)("h2",{id:"adding-the-cdn-to-the-api"},"Adding the CDN to the API"),(0,r.kt)("p",null,"After you've setup your CDN, you need to tell your API server that it is available. Inside of your ",(0,r.kt)("inlineCode",{parentName:"p"},"config.json")," file in your API server, you should see a property called ",(0,r.kt)("inlineCode",{parentName:"p"},"CDNURLs"),". You can add your url to that array."),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"Make sure your URL is ",(0,r.kt)("em",{parentName:"p"},"complete!")," The url should have ",(0,r.kt)("inlineCode",{parentName:"p"},"https://")," at the beginning and end with a trailing slash.")),(0,r.kt)("p",null,"After you've added the URL to the config, simply save and restart your API server, and your new CDN server should be accessible!"))}c.isMDXComponent=!0}}]);